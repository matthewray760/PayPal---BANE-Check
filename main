import pandas as pd
from sql import execute_query_bane
from sql import execute_query_sc
import tkinter
from message import show_popup,get_input


use_sql = True

date = get_input("Please enter the begin date: ")


## parse newly created securities from SQL
if use_sql == True:
    data = execute_query_sc(Date = date)
else:
    pathway_insert = fr'C:\Users\matthewray\OneDrive - Clearwater\Desktop\Python\PayPal - Bane Check\sc_bane_check_test.xlsx'
    data = pd.read_excel(pathway_insert)

df = data

##Clean for only floating rates
df =df.rename(columns = {'SecurityID': 'securityid'})
df = df[['tsCreated', 'securityid','AccountID','Cusip','ISIN','detailedDescription','Coupon','CpnFrequency','isFloatingRate','FloaterSpread']]
df = df[df['isFloatingRate'] == 1]


# convert security IDs to a comma separated list and create df_2 for Bane Table
security_id_list = df['securityid'].to_list()
security_ids_str = ', '.join(map(str, security_id_list))

## parse newly created securities from SQL
if use_sql == True:
    df_2 = execute_query_bane(security_ids = security_ids_str)
else:
    pathway_insert = fr'C:\Users\matthewray\OneDrive - Clearwater\Desktop\Python\PayPal - Bane Check\bane_table_test.xlsx'
    df_2 = pd.read_excel(pathway_insert)


## Join the two dfs

merged_df = pd.merge(df,df_2, on = 'securityid', how='outer')

#merged_df.to_excel(fr'C:\Users\matthewray\OneDrive - Clearwater\Desktop\Python\PayPal - Bane Check\Output\{date}_Output_test.xlsx')

merged_df = merged_df[merged_df['calcTypeCode'].isna() | (merged_df['calcTypeCode'] < 0)]


if merged_df.empty:
    show_popup('All Securities for the Period are on BANE')

else:
    merged_df.to_excel(fr'C:\Users\matthewray\OneDrive - Clearwater\Desktop\Python\PayPal - Bane Check\Output\Bane_Check_Output_{date}.xlsx')
    show_popup("One or more securities are not set up on BANE - see output file")



#merged_df.to_excel(fr'C:\Users\matthewray\OneDrive - Clearwater\Desktop\Python\PayPal - Bane Check\Output\{Date}_Output_test.xlsx')
